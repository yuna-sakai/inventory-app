CREATE DATABASE inventorydb;

\c inventorydb

CREATE TABLE roles (
    role_id INT PRIMARY KEY,
    role_name VARCHAR(50)
);

INSERT INTO roles (role_id, role_name) VALUES
(1, '管理者'),
(2, '一般');

CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    login_id VARCHAR(50) UNIQUE,
    user_name VARCHAR(50),
    password VARCHAR(50),
    role_id INT NOT NULL REFERENCES roles(role_id)
);

ALTER SEQUENCE users_user_id_seq RESTART WITH 101;

INSERT INTO users (login_id, user_name, password, role_id) VALUES
('admin', 'admin', 'admin', 1),
('user', 'user', 'user', 2);

CREATE TABLE inventories (
    item_id SERIAL PRIMARY KEY, 
    user_id INT NOT NULL REFERENCES users(user_id),
    item_name VARCHAR(50),
    quantity INT,
    expiration_date DATE
);

INSERT INTO inventories (user_id, item_name, quantity, expiration_date) VALUES
(101, '牛乳', 3, '2024-07-25');

-- 在庫一覧をソート付きで取得するビュー

CREATE VIEW v_inventories_sorted AS
SELECT item_id, user_id, item_name, quantity, expiration_date
FROM inventories
ORDER BY expiration_date ASC NULLS LAST, item_name ASC;

-- 期限切れアラート用のビュー

CREATE VIEW v_inventories_alert AS
SELECT item_id, user_id, item_name, quantity, expiration_date
FROM inventories
WHERE expiration_date <= CURRENT_DATE
ORDER BY expiration_date ASC, item_name ASC;
